<!DOCTYPE html>
<html lang="es">
    <head>
        <title>WebPage</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="UTF-8">
        <link href="https://camo.githubusercontent.com/cb43e20cc19c39374697ffe769744248aa8158a4ef4e2874bb33993b0f132d76/68747470733a2f2f696d672e69636f6e73382e636f6d2f737469636b6572732f3130302f3030303030302f646973636f72642e706e67" rel="shortcut icon" type="image/vnd.microsoft.icon">
        <style>
            
            table {
                width: 100%;
                margin-left: auto;
                margin-right: auto;
            }

            @media only screen and (min-width: 800px) {
                table {
                width: 500px;
                margin-left: auto;
                margin-right: auto;
            }

            }
            table, tr,td {
                border: 1px solid black;
                border-collapse: collapse;
                text-align: center;
            }
            tr {
                height: 20%;
            }

            td {
                height: 15%;
                padding:  3%;
            }

            .radio{
                text-align: left;
                padding-left: 1%;
            }
            input[type=number]{
                width: 11%;
            }
            .image {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 100%;
            }
            
            svg{
                width: 60px; 
                height: 60px;
            } 


        </style>    
    </head>
    <body style="font-family: 'Segoe UI'">
        <div>
            <table>
                <tr>
                    <th colspan="5"> 
                        <img src="https://github.com/FMFigueroa/superheroes/blob/main/public/assets/img/logo_team.png?raw=true" class="image" alt="logo_team">
                        Panel de Control
                    </th>
                    </tr>
                <form method="post" onsubmit="return checkTime();">
                    <tr>
                        <td colspan="2" width="40%"> <label for="inputAuto"> <b> <i> Modo de Operaci√≥n </i> </b> </label> </td>
                        <td width="35%" class="radio"> 
                            
                            <input type="radio" id="auto" name="inputAuto" value="auto"> <label for="auto">Automatico</label> <br>
                            <input type="radio" id="manual" name="inputAuto" value="manual"> <label for="manual">Manual</label> <br> 
                        </td>
                        <td width="25%" class="radio" style="border-collapse: separate;"> 
                            <input type="radio" id="manualON" name="manualInput" value="ON"> <label for="ON">ON</label> <br>
                            <input type="radio" id="manualOFF" name="manualInput" value="OFF"> <label for="OFF">OFF</label> <br> 
                        </td>
                        <td colspan="1">
                            <span id="ledApagado" style="display: none"> 
                                <svg>
                                    <circle fill="#ff0000" stroke="none" cx="30%" cy="50%" r="12" > 
                                    </circle>
                                </svg>
                            </span>
                            <span id="ledEncendido" style="display: none">                                 
                                <svg>
                                    <circle fill="#03AC13" stroke="none" cx="25%" cy="50%" r="12" > 
                                    <animate attributeName="opacity" dur="1s" values="0;1;0" repeatCount="indefinite" begin="0.1">
                                    </circle>
                                </svg>
                            </span>
                            <span id="ledSinConf" style="display: block">                                 
                                <svg>
                                    <circle fill="#000000" stroke="none" cx="25%" cy="50%" r="12" ></circle>
                                </svg>
                            </span>
                        </td> 
                    </tr>
                    <tr>
                        <td colspan="2"> <label for="inputPwm"> <b> <i> Nivel de Potencia </i> </b> </label> </td>
                        <td colspan="3"> <label style="padding-left: 10px">  0%</label> 
                            <input type="range" min="0" max="255" class="slider" name="inputPwm" id="inputPwm"  value=""> 
                            <label>100%</label><br>
                            <input type="text" style="width: 20%; text-align: center;" name="inputPwmShow" id="inputPwmShow"  value="" disabled>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2"> <label for="inputHorai"> <b> <i> Horario de Encendido</i> </b> </label> </td>
                        <td colspan="3"> <label for="inputHorai" style="text-align: center;">  Hora     :   Minutos  </label> <br>
                            <input type="number" name="inputHorai" id="inputHorai" min="0" max="23" value="">
                            <label> : </label>
                            <input type="number" name="inputMinutoi" id="inputMinutoi" min="0" max="59" value="">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2"> <label for="inputHoraf"> <b> <i> Horario de Apagado </i> </b> </label> </td>
                        <td colspan="3"> <label for="inputHoraf" style="text-align: center;">  Hora     :   Minutos  </label> <br>
                            <input type="number" name="inputHoraf" id="inputHoraf" min="0" max="23" value="">
                            <label> : </label>
                            <input type="number" name="inputMinutof" id="inputMinutof" min="0" max="59" value="">
                        </td>                                     
                    </tr>
                    <tr>
                        <td colspan="2" width="40%"> <label for="inputRampa"> <b> <i> Modo Sol </i> </b> </label> </td>
                        <td colspan="3" class="radio" style="padding-left: 20%;"> 
                            <input type="radio" id="rampaON" name="inputRampa" value="ON"> <label for="ON">Activada</label> <br>
                            <input type="radio" id="rampaOFF" name="inputRampa" value="OFF"> <label for="OFF">Desactivada</label> <br> 

                        </td>
                    </tr>
                    <tr>
                        <td colspan="5"> 
                            <input type="submit" class="button" onclick="checkTime()" value="Aplicar">
                    </tr>
                </form>
            </table>
        </div>
    </body>
    <script>
        
        var slider = document.getElementById("inputPwm")
        slider.addEventListener('input', function(){
            var porcentaje = Math.round(slider.value * 100 / 255)
            document.getElementById("inputPwmShow").value = porcentaje + "%";
        })        

        function setValues(statusJson){
            var toPorcentaje = (statusJson.potencia * 100 / 255);
            if (statusJson.modo === "auto"){
                var radiobtn = document.getElementById("auto");
                radiobtn.checked = true;
            }else if (statusJson.modo === "manual"){
                var radiobtn = document.getElementById("manual");
                radiobtn.checked = true;
            }

            if (statusJson.rampa === "ON"){
                var radiobtn = document.getElementById("rampaON");
                radiobtn.checked = true;
            }else if (statusJson.rampa === "OFF"){
                var radiobtn = document.getElementById("rampaOFF");
                radiobtn.checked = true;
            }

            if (statusJson.encendido === "ON"){
                var radiobtn = document.getElementById("manualON");
                radiobtn.checked = true;
                document.getElementById("ledEncendido").style.display = "block";
                document.getElementById("ledApagado").style.display = "none";
                document.getElementById("ledSinConf").style.display = "none";
            }else if (statusJson.encendido === "OFF"){
                var radiobtn = document.getElementById("manualOFF");
                radiobtn.checked = true;
                document.getElementById("ledEncendido").style.display = "none";
                document.getElementById("ledApagado").style.display = "block";
                document.getElementById("ledSinConf").style.display = "none";
            }

            document.getElementById("inputHorai").value = statusJson.horasi;
            document.getElementById("inputMinutoi").value = statusJson.minutosi;
            document.getElementById("inputHoraf").value = statusJson.horasf;
            document.getElementById("inputMinutof").value = statusJson.minutosf;
            document.getElementById("inputPwm").value = statusJson.potencia;
            document.getElementById("inputPwmShow").value = Math.round(toPorcentaje) +"%";
        }
        function checkTime() {
            var horai = document.getElementById("inputHorai").value;
            var minutoi = document.getElementById("inputMinutoi").value;
            var horaf = document.getElementById("inputHoraf").value;
            var minutof = document.getElementById("inputMinutof").value;
            var duracionRampa = (30) // 30 min de rampa

            var decimali = (parseInt(horai) * 60 ) + (parseInt(minutoi))
            var decimalf = (parseInt(horaf) * 60) + parseInt((minutof))
            if ( decimalf >= decimali && decimalf-decimali <  duracionRampa)
            {
                //alert('La hora de final debe ser mayor de 30 min de la hora de inicio');
                //return false;
                return true;
            } else {
                return true;
            }
       }

    //json loader
        function getReadings(){
            var statusJson = {"modo":"","horasi":"","minutosi":"","horasf":"","minutosf":"","potencia":"","encendido":"","rampa":""};
            var d_file = "parametros.json";
            var http_request = new XMLHttpRequest();
            http_request.onreadystatechange = function(){
                if (http_request.readyState == 4 && http_request.status == 200) {
                    statusJson = JSON.parse(http_request.responseText);
                    console.log(statusJson)
                    setValues(statusJson);               
                }
            }
            http_request.open("GET", "parametros.json", true);
            http_request.send();
        }
        getReadings();
        
        setInterval(getReadings, 20000);

    </script>
</html>